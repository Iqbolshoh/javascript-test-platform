<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test | By Iqbolshoh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="https://iqbolshoh.uz/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <link rel="stylesheet" href="./src/css/style.css">
</head>

<body>
    <div class="card d-none" id="game-card">
        <h4 id="question-number" class="text-muted"></h4>
        <h2 id="quiz-container">
            <span id="quiz-text">üîÑ</span>
        </h2>
        <p id="emoji" class="fs-1">‚ùì</p>
        <div id="options" class="d-grid gap-3"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const gameCard = document.getElementById("game-card");
            const quizContainer = document.getElementById("quiz-text");
            const questionNumber = document.getElementById("question-number");
            const optionsContainer = document.getElementById("options");

            let lessons = [];
            let currentIndex = 0;
            let mistakeCount = 0;
            let totalScore = 0;
            let isProcessing = false;
            let timer;
            let timeLeft = 15;

            async function loadLessons() {
                try {
                    const response = await fetch('./src/js/lesson.json');
                    lessons = await response.json();
                    resetGame();
                    gameCard.classList.remove("d-none");
                    loadQuestion();
                } catch (error) {
                    console.error("Error:", error);
                }
            }

            loadLessons();

            function loadQuestion() {
                if (currentIndex >= lessons.length) {
                    showResult("üéâ Great result!", `You completed all the quizzes! Total score: ${totalScore}`, "success", resetGame);
                    return;
                }

                const currentLesson = lessons[currentIndex];
                const quizText = capitalize(currentLesson.quiz);

                quizContainer.innerText = quizText;
                updateTimerDisplay();

                generateOptions(currentLesson);
                startTimer();
            }

            function generateOptions(currentLesson) {
                let options = [
                    currentLesson["option-1"],
                    currentLesson["option-2"],
                    currentLesson["option-3"],
                    currentLesson["option-4"]
                ];

                optionsContainer.innerHTML = shuffle(options).map(option =>
                    `<button class="btn" onclick="checkAnswer(\`${option}\`, \`${currentLesson["option-1"]}\`)">${option}</button>`
                ).join("");
            }

            window.checkAnswer = function (selected, correctAnswer) {
                if (isProcessing) return;
                isProcessing = true;

                if (selected === correctAnswer) {
                    totalScore += 10;
                    clearInterval(timer);
                    showResult("‚úÖ Correct!", `Let's continue! Your score is: ${totalScore}`, "success", () => {
                        currentIndex++;
                        timeLeft = 15;
                        isProcessing = false;
                        loadQuestion();
                    });
                } else {
                    mistakeCount++;
                    if (mistakeCount >= 3) {
                        clearInterval(timer);
                        showResult("‚ùå You made too many mistakes!", `The game will restart. Total score: ${totalScore}`, "error", () => {
                            isProcessing = false;
                            resetGame();
                        });
                    } else {
                        showResult("‚ùå Wrong!", `You have made ${mistakeCount} mistakes. The game ends after 3 mistakes! Total score: ${totalScore}`, "error", () => {
                            isProcessing = false;
                        });
                    }
                }
            };

            function resetGame() {
                currentIndex = mistakeCount = 0;
                totalScore = 0;
                timeLeft = 15;
                loadQuestion();
            }

            function showResult(title, text, icon, callback) {
                Swal.fire({ title, text, icon, timer: icon === "success" ? 1000 : 1500, showConfirmButton: icon !== "success", position: "top", backdrop: false }).then(callback);
            }

            function capitalize(text) {
                return text.charAt(0).toUpperCase() + text.slice(1);
            }

            function shuffle(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            function startTimer() {
                clearInterval(timer);
                timeLeft = 15;
                updateTimerDisplay();

                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        showResult("‚è≥ Time is up!", "Let's move on to the next question.", "info", () => {
                            currentIndex++;
                            loadQuestion();
                        });
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                questionNumber.innerText = `Time: ${minutes}:${seconds.toString().padStart(2, '0')} | Question ${currentIndex + 1} / ${lessons.length} | Score: ${totalScore}`;
            }
        });
    </script>
</body>

</html>