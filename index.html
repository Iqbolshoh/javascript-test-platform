<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game | By Iqbolshoh</title>
    <link rel="stylesheet" href="./src/css/style.css">
    <link rel="icon" href="https://iqbolshoh.uz/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
</head>

<body>
    <div class="card quiz-card d-none" id="game-card">
        <h4 id="question-number" class="quiz-timer"></h4>
        <h2 id="quiz-container" class="mb-4">
            <span id="quiz-text">üîÑ</span>
        </h2>
        <p id="emoji" class="quiz-emoji">‚ùì</p>
        <div id="options" class="quiz-options"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const gameCard = document.getElementById("game-card");
            const quizContainer = document.getElementById("quiz-text");
            const questionNumber = document.getElementById("question-number");
            const optionsContainer = document.getElementById("options");

            let lessons = [];
            let currentIndex = 0;
            let mistakeCount = 0;
            let totalScore = 0;
            let isProcessing = false;
            let timer;
            let timeLeft = 15;

            function escapeHTML(str) {
                const div = document.createElement("div");
                div.textContent = str;
                return div.innerHTML;
            }

            async function loadLessons() {
                try {
                    const response = await fetch('./src/json/test.json');
                    lessons = await response.json();
                    resetGame();
                    gameCard.classList.remove("d-none");
                    loadQuestion();
                } catch (error) {
                    console.error("Error:", error);
                }
            }

            loadLessons();

            function loadQuestion() {
                if (currentIndex >= lessons.length) {
                    showResult("üéâ Excellent result!", `All questions completed! Total score: ${totalScore}`, "success", resetGame);
                    return;
                }

                const currentLesson = lessons[currentIndex];
                const quizText = `${currentIndex + 1}) ${capitalize(escapeHTML(currentLesson.quiz))}`;

                quizContainer.innerHTML = quizText;
                updateTimerDisplay();
                generateOptions(currentLesson);
                startTimer();
            }

            function generateOptions(currentLesson) {
                let options = [
                    currentLesson["option-1"],
                    currentLesson["option-2"],
                    currentLesson["option-3"],
                    currentLesson["option-4"]
                ];

                optionsContainer.innerHTML = shuffle(options).map(option =>
                    `<button class="btn btn-outline-primary" onclick="checkAnswer(\`${escapeHTML(option)}\`, \`${escapeHTML(currentLesson["option-1"])}\`)">${escapeHTML(option)}</button>`
                ).join("");
            }

            window.checkAnswer = function (selected, correctAnswer) {
                if (isProcessing) return;
                isProcessing = true;

                if (selected === correctAnswer) {
                    totalScore += 10;
                    clearInterval(timer);
                    showResult("‚úÖ Correct!", `Score: ${totalScore}`, "success", () => {
                        currentIndex++;
                        timeLeft = 15;
                        isProcessing = false;
                        loadQuestion();
                    });
                } else {
                    mistakeCount++;
                    if (mistakeCount >= 3) {
                        clearInterval(timer);
                        showResult("‚ùå Too many mistakes!", `Restarting... Score: ${totalScore}`, "error", resetGame);
                    } else {
                        showResult("‚ùå Incorrect!", `Mistakes: ${mistakeCount} (3 mistakes allowed)`, "error", () => {
                            isProcessing = false;
                        });
                    }
                }
            };

            function resetGame() {
                clearInterval(timer);
                currentIndex = mistakeCount = 0;
                totalScore = 0;
                timeLeft = 15;
                isProcessing = false;
                loadQuestion();
            }

            function showResult(title, text, icon, callback) {
                Swal.fire({
                    title,
                    text,
                    icon,
                    timer: icon === "success" ? 1000 : 1500,
                    showConfirmButton: icon !== "success",
                    position: "top",
                    backdrop: false
                }).then(callback);
            }

            function capitalize(text) {
                return text.charAt(0).toUpperCase() + text.slice(1);
            }

            function shuffle(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            function startTimer() {
                clearInterval(timer);
                timeLeft = 15;
                updateTimerDisplay();

                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        showResult("‚è≥ Time's up!", "Loading next question...", "info", () => {
                            currentIndex++;
                            loadQuestion();
                        });
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                questionNumber.innerText = `Time: ${minutes}:${seconds.toString().padStart(2, '0')} | Question ${currentIndex + 1}/${lessons.length} | Score: ${totalScore}`;
            }
        });
    </script>
</body>

</html>