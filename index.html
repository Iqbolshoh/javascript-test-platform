<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game | By Iqbolshoh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-...">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-..." crossorigin="anonymous">
    <link rel="stylesheet" href="./src/css/style.css">
    <link rel="icon" href="https://iqbolshoh.uz/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
</head>

<body>
    <div class="card quiz-card d-none" id="game-card">
        <h4 id="question-number" class="quiz-timer"></h4>
        <h2 id="quiz-container" class="mb-4">
            <span id="quiz-text">üîÑ</span>
        </h2>
        <p id="emoji" class="quiz-emoji">‚ùì</p>
        <div id="options" class="quiz-options"></div>
    </div>

    <script>
        (function () {
            'use strict';

            const elements = {
                gameCard: document.getElementById('game-card'),
                quizText: document.getElementById('quiz-text'),
                questionNumber: document.getElementById('question-number'),
                optionsContainer: document.getElementById('options'),
                emoji: document.getElementById('emoji')
            };

            const state = {
                lessons: [],
                currentIndex: 0,
                mistakeCount: 0,
                totalScore: 0,
                isProcessing: false,
                timer: null,
                timeLeft: 15
            };

            const utils = {
                escapeHTML: str => {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                },

                capitalize: text => text.charAt(0).toUpperCase() + text.slice(1),

                shuffle: array => {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                },

                formatTime: seconds => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                }
            };

            const game = {
                async init() {
                    try {
                        const response = await fetch('./src/js/lesson.json');
                        if (!response.ok) throw new Error('Failed to load questions');

                        state.lessons = await response.json();
                        if (!state.lessons.length) throw new Error('No questions available');

                        this.reset();
                        elements.gameCard.classList.remove('d-none');
                        this.loadQuestion();
                    } catch (error) {
                        console.error('Initialization error:', error);
                        this.showResult('‚ùå Error', 'Failed to load questions. Please try again.', 'error', () => {
                            window.location.reload();
                        });
                    }
                },

                reset() {
                    state.currentIndex = 0;
                    state.mistakeCount = 0;
                    state.totalScore = 0;
                    state.timeLeft = 15;
                    clearInterval(state.timer);
                },

                loadQuestion() {
                    if (state.currentIndex >= state.lessons.length) {
                        this.showResult(
                            'üéâ Quiz Completed!',
                            `Your final score: ${state.totalScore}/${state.lessons.length * 10}`,
                            'success',
                            this.reset.bind(this)
                        );
                        return;
                    }

                    const current = state.lessons[state.currentIndex];
                    elements.quizText.innerHTML = `${state.currentIndex + 1}) ${utils.capitalize(utils.escapeHTML(current.quiz))}`;
                    this.updateTimerDisplay();
                    this.generateOptions(current);
                    this.startTimer();
                },

                generateOptions(lesson) {
                    const options = [
                        lesson['option-1'],
                        lesson['option-2'],
                        lesson['option-3'],
                        lesson['option-4']
                    ];

                    elements.optionsContainer.innerHTML = utils.shuffle([...options])
                        .map(opt => `
                            <button class="btn btn-outline-primary quiz-option" 
                                    onclick="game.checkAnswer('${utils.escapeHTML(opt)}', '${utils.escapeHTML(lesson['option-1'])}')">
                                ${utils.escapeHTML(opt)}
                            </button>
                        `).join('');
                },

                checkAnswer(selected, correct) {
                    if (state.isProcessing) return;
                    state.isProcessing = true;

                    if (selected === correct) {
                        state.totalScore += 10;
                        clearInterval(state.timer);
                        this.showResult(
                            '‚úÖ Correct!',
                            `Score: ${state.totalScore}`,
                            'success',
                            () => {
                                state.currentIndex++;
                                state.timeLeft = 15;
                                state.isProcessing = false;
                                this.loadQuestion();
                            }
                        );
                    } else {
                        state.mistakeCount++;
                        if (state.mistakeCount >= 3) {
                            clearInterval(state.timer);
                            this.showResult(
                                '‚ùå Game Over',
                                `Too many mistakes! Final score: ${state.totalScore}`,
                                'error',
                                () => {
                                    this.reset();
                                    this.loadQuestion();
                                }
                            );
                        } else {
                            this.showResult(
                                '‚ùå Wrong Answer',
                                `Mistakes: ${state.mistakeCount}/3`,
                                'error',
                                () => {
                                    state.isProcessing = false;
                                }
                            );
                        }
                    }
                },

                startTimer() {
                    clearInterval(state.timer);
                    state.timeLeft = 15;
                    this.updateTimerDisplay();

                    state.timer = setInterval(() => {
                        state.timeLeft--;
                        this.updateTimerDisplay();

                        if (state.timeLeft <= 0) {
                            clearInterval(state.timer);
                            this.showResult(
                                '‚è≥ Time Expired!',
                                'Moving to next question...',
                                'info',
                                () => {
                                    state.currentIndex++;
                                    this.loadQuestion();
                                }
                            );
                        }
                    }, 1000);
                },

                updateTimerDisplay() {
                    elements.questionNumber.textContent =
                        `Time: ${utils.formatTime(state.timeLeft)} | ` +
                        `Question ${state.currentIndex + 1}/${state.lessons.length} | ` +
                        `Score: ${state.totalScore}`;
                },

                showResult(title, text, icon, callback) {
                    Swal.fire({
                        title,
                        text,
                        icon,
                        timer: icon === 'success' ? 1000 : 1500,
                        showConfirmButton: icon !== 'success',
                        position: 'top',
                        backdrop: false,
                        allowOutsideClick: false
                    }).then(callback);
                }
            };

            window.game = game;

            document.addEventListener('DOMContentLoaded', () => game.init());
        })();
    </script>
</body>

</html>